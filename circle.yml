machine:
  java:
    version: oraclejdk8
  pre:
    - git config --global user.name "CircleCI"
    - git config --global user.email "circleci@omnypay.net"
    - git config --global push.default simple
  post:
    - go get github.com/omnypay/github-release

  environment:
    VERSION_FILE: $HOME/VERSION
    SERVICE_NAME: nomad
    ASSET_BUCKET: omnypay-app-assets-us-west-2
  services:
    - docker

dependencies:
  pre:
    - sudo pip install --upgrade awscli
    - git clone https://${READ_BOT_TOKEN}@github.com/omnypay/omnypay-ci.git  ~/omnypay-ci --depth 1 --quiet
    - mkdir -p ~/.lein; cp ~/omnypay-ci/lein/profiles.clj ~/.lein

test:
  override:
    - lein test

deployment:
  assets:
    branch: master
    commands:
      - ~/omnypay-ci/semver-monotonic $VERSION_FILE
      # Push to Github release
      - export SEMVER=$(cat $VERSION_FILE); github-release release --user $CIRCLE_PROJECT_USERNAME --repo $CIRCLE_PROJECT_REPONAME --tag v$SEMVER  --target $CIRCLE_SHA1
      - export SEMVER=$(cat $VERSION_FILE); lein deploy prod
